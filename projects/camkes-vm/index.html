<!DOCTYPE html>
<!--
     SPDX-License-Identifier: CC-BY-SA-4.0
     SPDX-FileCopyrightText: 2020 seL4 Project a Series of LF Projects, LLC.
-->
<!-- Page last generated 2022-03-18 03:18:47 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CAmkES x86 VM | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117737473-2"></script>
<script>
  if((window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window['ga-disable-UA-117737473-2'] = true;
  }
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117737473-2');
</script>
</head>

  <body class="container-fluid">

    



<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="https://sel4.systems" class="skip-icon">
              <img class="img-responsive" src="/assets/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/processes">Contributing</a></h2>
        <h2><a href="/projects">Projects</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <iframe title="DuckDuckGo search bar" src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search%20sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;border-width: 0px"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  
<div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
            </a>
            <meta property="position" content="1" />
        </li>
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/projects/">
              <span property="name"><b>Projects</b></span>
            </a>
            <meta property="position" content="2" />
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">CAmkES x86 VM</span>
            <meta property="position" content="3" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/releases/sel4/12.1.0"><b>seL4-12.1.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/camkes/camkes-3.10.0"><b>camkes-3.10.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/capdl/0.2.1"><b>CapDL-0.2.1</b></a></li>
    </ol>
  </nav>
  <nav class="sel-version">
    <ol class="list-unstyled">
      <li class="list-unstyled text-center">
      <a href="https://sel4.discourse.group/t/15-june-2021-release/373"><b>Announcing new releases: </b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      <div class="row">
  <div class="hidden-xs col-sm-4 col-md-3 col-lg-2">
    


<div class="sidebar">















    <ul class="nav nav-sidebar">
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4/">seL4</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/l4v/">L4.verified</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/camkes/">CAmkES</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/capdl/">CapDL</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/buildsystem/">seL4 Buildsystem</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/elfloader/">Elfloader</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/user_libs/">user_libs</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4runtime/">The seL4 run-time</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4test/">seL4Test</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4-tutorials/">seL4 tutorials</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4webserver/">seL4webserver</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4bench/">sel4bench</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/camkes-arm-vm/">camkes-arm-vm</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/virtualization/">Virtualization</a>
        <li>
  
    
    

    
        <li class="active">
            <a class="" href="/projects/camkes-vm/">camkes-vm</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/docsite/">seL4 Documentation website</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4_tools/">seL4_tools</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/dockerfiles/">Dockerfiles</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/hardware_hacks/">Hardware Hacks</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/rust/">Rust</a>
        <li>
  
    </ul>




</div>


  </div>
  <div class="content col-sm-8 col-md-6 col-lg-7 main">
    <h1 id="camkes-x86-vm">CAmkES x86 VM</h1>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Get the dependencies for building CAmkES by following
the instructions <a href="HostDependencies#camkes-build-dependencies">here</a></li>
  <li>Your host machine has to have a CPU that supports Vt-x virtualization
 (for Intel CPUs), or AMD-V (for AMD CPUs, but that wasn’t tested). Any
newer i7 core should have Vt-x. Note that you might have to enable it
first from BIOS. You can always check by <code class="highlighter-rouge">lscpu</code> and look for <strong>vmx</strong> flag.</li>
</ul>

<h2 id="tutorials">Tutorials</h2>

<p>Use the following tutorials to learn about the VM:</p>

<ol>
  <li><a href="/Tutorials/camkes-vm-linux.html">Camkes VM Linux</a> using Linux as a guest in the Camkes VM.</li>
  <li><a href="/Tutorials/camkes-vm-crossvm.html">Camkes Cross-VM communication</a> walkthrough of adding communication between Linux guests in separate VMs.</li>
</ol>

<h2 id="examples">Examples</h2>

<ul>
  <li><a href="centos">Centos</a></li>
  <li><a href="zmq-samples">zmq_samples</a></li>
</ul>

<h2 id="booting-from-hard-drive">Booting from hard drive</h2>

<p>These instructions are for ubuntu. For CentOS instructions, see
<a href="CAmkESVMCentOS">CAmkESVMCentOS</a>.</p>

<p>So far we’ve only run a tiny linux on a ram disk. What if we want to run
Ubuntu booting off a hard drive? This section will explain the changes
we need to make to our VM app to allow it to boot into a Ubuntu
environment installed on the hard drive. Thus far these examples should
have been compatible with most modern x86 machines. The rest of this
tutorial will focus on a particular machine:
<a href="https://www.rtd.com/PC104/CM/CMA34CR/CMA34CR.htm">the cma34cr
single board computer</a></p>

<p>The first step is to install ubuntu natively on the cma34cr. It’s
currently required that guests of the camkes vm run in 32-bit mode, so
install 32-bit ubuntu. These examples will use ubuntu-16.04.</p>

<p>The plan will be to give the guest passthrough access to the hard drive,
and use a ubuntu initrd as our initial root filesystem, replacing the
buildroot one used thus far. We’ll use the same kernel image as before,
as our vm requires that PAE be turned off, and it’s on by default in the
ubuntu kernel.</p>

<h3 id="getting-the-initrd-image">Getting the initrd image</h3>

<p>We need to generate a root filesystem image suitable for ubuntu. Ubuntu
ships with a tool called mkinitramfs which generates root filesystem
images. Let’s use it to generate a root filesystem image compatible with
the linux kernel we’ll be using. Boot ubuntu natively on the cma34cr and
run the following command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkinitramfs -o rootfs.cpio 4.8.16
WARNING: missing /lib/modules/4.8.16
Ensure all necessary drivers are built into the linux image!
depmod: ERROR: could not open directory /lib/modules/4.8.16: No such file or directory
depmod: FATAL: could not search modules: No such file or directory
depmod: WARNING: could not open /var/tmp/mkinitramfs_H9SRHb/lib/modules/4.8.16/modules.order: No such file or directory
depmod: WARNING: could not open /var/tmp/mkinitramfs_H9SRHb/lib/modules/4.8.16/modules.builtin: No such file or directory
</code></pre></div></div>

<p>The kernel we’ll be using has all the necessary drivers built in, so
feel free to ignore those warnings and errors. You should now have a
file called rootfs.cpio on the cma34cr. Transfer that file to your dev
machine, and put it in <code class="highlighter-rouge">projects/vm/minimal</code>. Now we need to tell the
build system to take that rootfs image rather than the default buildroot
one. Edit <code class="highlighter-rouge">projects/vm-examples/minimal/CMakeLists.txt</code>. Change this line:</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">AddToFileServer</span><span class="p">(</span><span class="s2">"rootfs.cpio"</span> <span class="si">${</span><span class="nv">rootfs_file</span><span class="si">}</span><span class="p">)</span>
</code></pre></div></div>
<p>to</p>
<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">AddToFileServer</span><span class="p">(</span><span class="s2">"rootfs.cpio"</span> &lt;ROOTFS_FILENAME&gt;<span class="p">)</span>
</code></pre></div></div>
<p>where <code class="highlighter-rouge">&lt;ROOTFS_FILENAME&gt;</code> is replaced with the filename of the rootfs file you 
added in <code class="highlighter-rouge">projects/vm/minimal</code>.</p>

<p>Since we’ll be using a real hard drive, we need to change the boot
command line we give to the guest linux. Open
<code class="highlighter-rouge">projects/vm-examples/minimal/minimal.camkes</code>, and change the
definition of <code class="highlighter-rouge">VM_GUEST_CMDLINE</code> to:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define VM_GUEST_CMDLINE "earlyprintk=ttyS0,115200 console=ttyS0,115200 i8042.nokbd=y i8042.nomux=y i8042.noaux=y io_delay=udelay noisapnp pci=nomsi debug root=/dev/sda1 rdinit=/init 2"
</code></pre></div></div>

<p>Try building and running after this change:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BusyBox v1.22.1 (Ubuntu 1:1.22.0-15ubuntu1) built-in shell (ash)
Enter 'help' for a list of built-in commands.

(initramfs)
</code></pre></div></div>

<p>You should get dropped into a shell inside the root filesystem. You can
run commands from here:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(initramfs) pwd
/
(initramfs) ls
dev      run      init     scripts  var      usr      sys      tmp
root     sbin     etc      bin      lib      conf     proc
</code></pre></div></div>

<p>If you look inside <code class="highlighter-rouge">/dev</code>, you’ll notice the lack of sda device. Linux
can’t find the hard drive because we haven’t passed it through yet.
Let’s do that now!</p>

<p>We’re going to give the guest passthrough access to the sata controller.
The sata controller will be in one of two modes: AHCI or IDE. The mode
can be set when configuring BIOS. By default it should be AHCI. The next
part has some minor differences depending on the mode. I’ll show both.
Open <code class="highlighter-rouge">projects/vm-examples/minimal/minimal.camkes</code> and add the following to the
configuration section:</p>

<p>For AHCI:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">configuration</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="n">vm0_config</span><span class="p">.</span><span class="n">pci_devices_iospace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


    <span class="n">vm0_config</span><span class="p">.</span><span class="n">ioports</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4088</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x4090</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4094</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x4098</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4080</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x4088</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4060</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x4080</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">];</span>
    
    <span class="n">vm0_config</span><span class="p">.</span><span class="n">pci_devices</span> <span class="o">=</span> <span class="p">[</span> 
        <span class="p">{</span>   
            <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span>
            <span class="s">"bus"</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="s">"dev"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span>
            <span class="s">"fun"</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="s">"irq"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span>
            <span class="s">"memory"</span><span class="o">:</span><span class="p">[</span>
                <span class="p">{</span><span class="s">"paddr"</span><span class="o">:</span><span class="mh">0xc0713000</span><span class="p">,</span> <span class="s">"size"</span><span class="o">:</span><span class="mh">0x800</span><span class="p">,</span> <span class="s">"page_bits"</span><span class="o">:</span><span class="mi">12</span><span class="p">},</span>
            <span class="p">],</span>
        <span class="p">},</span>  
    <span class="p">];</span>

    <span class="n">vm0_config</span><span class="p">.</span><span class="n">irqs</span> <span class="o">=</span> <span class="p">[</span> 
        <span class="p">{</span><span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span> <span class="s">"source"</span><span class="o">:</span><span class="mi">19</span><span class="p">,</span> <span class="s">"level_trig"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"active_low"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"dest"</span><span class="o">:</span><span class="mi">11</span><span class="p">},</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For IDE:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">configuration</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="n">vm0_config</span><span class="p">.</span><span class="n">pci_devices_iospace</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">vm0_config</span><span class="p">.</span><span class="n">ioports</span> <span class="o">=</span> <span class="p">[</span> 
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4080</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x4090</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4090</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40a0</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40b0</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40b8</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40b8</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40c0</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40c8</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40cc</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40cc</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40d0</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">];</span>  

    <span class="n">vm0_config</span><span class="p">.</span><span class="n">pci_devices</span> <span class="o">=</span> <span class="p">[</span> 
        <span class="p">{</span>   
            <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span>
            <span class="s">"bus"</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="s">"dev"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span>
            <span class="s">"fun"</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="s">"irq"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span>
            <span class="s">"memory"</span><span class="o">:</span><span class="p">[],</span>
        <span class="p">},</span>  
    <span class="p">];</span>  

    <span class="n">vm0_config</span><span class="p">.</span><span class="n">irqs</span> <span class="o">=</span> <span class="p">[</span> 
        <span class="p">{</span><span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span> <span class="s">"source"</span><span class="o">:</span><span class="mi">19</span><span class="p">,</span> <span class="s">"level_trig"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"active_low"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"dest"</span><span class="o">:</span><span class="mi">11</span><span class="p">},</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now rebuild and run:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ubuntu 16.04.1 LTS ertos-CMA34CR ttyS0

ertos-CMA34CR login: 
</code></pre></div></div>

<p>You should be able to log in and use the system largely as normal.</p>

<h2 id="passthrough-ethernet">Passthrough Ethernet</h2>

<p>The ethernet device is not accessible to the guest:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1
    link/sit 0.0.0.0 brd 0.0.0.0
</code></pre></div></div>

<p>An easy way to give the guest network access is to give it passthrough
access to the ethernet controller. This is done much in the same way as
enabling passthrough access to the sata controller. In the configuration
section in <code class="highlighter-rouge">projects/vm-examples/minimal/minimal.camkes</code>, add to the list of io
ports, pci devices and irqs to pass through:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vm0_config</span><span class="p">.</span><span class="n">ioports</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4080</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x4090</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x4090</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40a0</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40b0</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40b8</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40b8</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40c0</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40c8</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40cc</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x40cc</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x40d0</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"start"</span><span class="o">:</span><span class="mh">0x3000</span><span class="p">,</span> <span class="s">"end"</span><span class="o">:</span><span class="mh">0x3020</span><span class="p">,</span> <span class="s">"pci_device"</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">"name"</span><span class="o">:</span><span class="s">"Ethernet5"</span><span class="p">},</span> <span class="c1">// &lt;--- Add this entry</span>
<span class="p">];</span>

<span class="n">vm0_config</span><span class="p">.</span><span class="n">pci_devices</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>   
        <span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span>
        <span class="s">"bus"</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s">"dev"</span><span class="o">:</span><span class="mh">0x1f</span><span class="p">,</span>
        <span class="s">"fun"</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
        <span class="s">"irq"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span>
        <span class="s">"memory"</span><span class="o">:</span><span class="p">[],</span>
    <span class="p">},</span>

    <span class="c1">// Add this entry:</span>
    <span class="p">{</span>
        <span class="s">"name"</span><span class="o">:</span><span class="s">"Ethernet5"</span><span class="p">,</span>
        <span class="s">"bus"</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span>
        <span class="s">"dev"</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s">"fun"</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s">"irq"</span><span class="o">:</span><span class="s">"Ethernet5"</span><span class="p">,</span>
        <span class="s">"memory"</span><span class="o">:</span><span class="p">[</span>
            <span class="p">{</span><span class="s">"paddr"</span><span class="o">:</span><span class="mh">0xc0500000</span><span class="p">,</span> <span class="s">"size"</span><span class="o">:</span><span class="mh">0x20000</span><span class="p">,</span> <span class="s">"page_bits"</span><span class="o">:</span><span class="mi">12</span><span class="p">},</span>
            <span class="p">{</span><span class="s">"paddr"</span><span class="o">:</span><span class="mh">0xc0520000</span><span class="p">,</span> <span class="s">"size"</span><span class="o">:</span><span class="mh">0x4000</span><span class="p">,</span> <span class="s">"page_bits"</span><span class="o">:</span><span class="mi">12</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">];</span>

<span class="n">vm0_config</span><span class="p">.</span><span class="n">irqs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">"name"</span><span class="o">:</span><span class="s">"SATA"</span><span class="p">,</span> <span class="s">"source"</span><span class="o">:</span><span class="mi">19</span><span class="p">,</span> <span class="s">"level_trig"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"active_low"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"dest"</span><span class="o">:</span><span class="mi">11</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"name"</span><span class="o">:</span><span class="s">"Ethernet5"</span><span class="p">,</span> <span class="s">"source"</span><span class="o">:</span><span class="mh">0x11</span><span class="p">,</span> <span class="s">"level_trig"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"active_low"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">"dest"</span><span class="o">:</span><span class="mi">10</span><span class="p">},</span> <span class="c1">// &lt;--- Add this entry</span>
<span class="p">];</span>
</code></pre></div></div>

<p>You should have added a new entry to each of the three lists that
describe passthrough devices. Building and running:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:d0:81:09:0c:7d brd ff:ff:ff:ff:ff:ff
    inet 10.13.1.87/23 brd 10.13.1.255 scope global dynamic enp0s2
       valid_lft 14378sec preferred_lft 14378sec
    inet6 2402:1800:4000:1:90b3:f9d:ae22:33b7/64 scope global temporary dynamic 
       valid_lft 86390sec preferred_lft 14390sec
    inet6 2402:1800:4000:1:aa67:5925:2cbc:928f/64 scope global mngtmpaddr noprefixroute dynamic 
       valid_lft 86390sec preferred_lft 14390sec
    inet6 fe80::cc47:129d:bdff:a2da/64 scope link 
       valid_lft forever preferred_lft forever
3: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1
    link/sit 0.0.0.0 brd 0.0.0.0
$ ping google.com
PING google.com (172.217.25.142) 56(84) bytes of data.
64 bytes from syd15s03-in-f14.1e100.net (172.217.25.142): icmp_seq=1 ttl=51 time=2.17 ms
64 bytes from syd15s03-in-f14.1e100.net (172.217.25.142): icmp_seq=2 ttl=51 time=1.95 ms
64 bytes from syd15s03-in-f14.1e100.net (172.217.25.142): icmp_seq=3 ttl=51 time=1.99 ms
64 bytes from syd15s03-in-f14.1e100.net (172.217.25.142): icmp_seq=4 ttl=51 time=2.20 ms
</code></pre></div></div>

<h2 id="figuring-out-information-about-pci-devices">Figuring out information about PCI devices</h2>

<p>To add a new passthrough device, or access a pci device in general, we
need to know which io ports it uses, which interrupts it’s associated
with, and the physical addresses of any memory-mapped io regions it
uses. The easiest way to find this information is to boot linux
natively, and run the command <code class="highlighter-rouge">lspci -vv</code>.</p>

<h2 id="configuring-a-linux-kernel-build">Configuring a Linux kernel build</h2>

<p>We provide a custom kernel image with our CAmkES VM project, found <a href="https://github.com/seL4/camkes-vm-linux/tree/master/images/kernel">here</a>.
This kernel image is produced from building Linux 4.8.16, specifically configured with the following <a href="https://github.com/seL4/camkes-vm-linux/tree/master/linux_configs/4.8.16">.config file</a>.</p>

<p>However you may decide to build your own Linux kernel image (which may be a different version). When doing so, it is important to ensure the build is configured with the following Kbuild settings:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># General kernel settings
CONFIG_X86_32=y
CONFIG_X86=y
CONFIG_X86_32_SMP=n
CONFIG_SMP=n
CONFIG_NOHIGHMEM=y
CONFIG_PCI_MSI=n
CONFIG_X86_UP_APIC=n
# Power management and ACPI settings
CONFIG_SUSPEND=n
CONFIG_HIBERNATION=n
CONFIG_PM=n
CONFIG_ACPI=n
# Virtio Settings
CONFIG_VIRTIO=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_NET=y
</code></pre></div></div>

<p>You can configure these settings by either manually editing your kernel <code class="highlighter-rouge">.config</code> file in the root project directory or by interactively running <code class="highlighter-rouge">make menuconfig</code>.</p>

  </div>







  
    
<div class="sidebar-toc hidden-xs hidden-sm col-md-3 col-lg-3">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#prerequisites">Prerequisites</a></li>
<li class="toc-entry toc-h2"><a href="#tutorials">Tutorials</a></li>
<li class="toc-entry toc-h2"><a href="#examples">Examples</a></li>
<li class="toc-entry toc-h2"><a href="#booting-from-hard-drive">Booting from hard drive</a>
<ul>
<li class="toc-entry toc-h3"><a href="#getting-the-initrd-image">Getting the initrd image</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#passthrough-ethernet">Passthrough Ethernet</a></li>
<li class="toc-entry toc-h2"><a href="#figuring-out-information-about-pci-devices">Figuring out information about PCI devices</a></li>
<li class="toc-entry toc-h2"><a href="#configuring-a-linux-kernel-build">Configuring a Linux kernel build</a></li>
</ul>
</div>

  
  
<div class="sidebar-toc hidden-xs hidden-sm col-md-3 col-lg-3">
  
    <ul class="section-nav">
    	<h2> camkes-vm </h2> 
        <li>
          
          <a style=" font-weight: bold; " class="" href="/projects/camkes-vm/">
            Documentation homepage
          </a>
        </li>

















    
        <h3>Repositories</h3>
    
        <li>
          <a class="" href="https://github.com/seL4/camkes-vm">
            camkes-vm
          </a>
        </li>

    
        <li>
          <a class="" href="https://github.com/seL4/camkes-vm-examples">
            camkes-vm-examples
          </a>
        </li>

    
        <li>
          <a class="" href="https://github.com/seL4/camkes-vm-examples-manifest">
            camkes-vm-examples-manifest
          </a>
        </li>









  





    
        <h3>Recent Updates</h3>
    
        <li>
          <a style="" href="/updates/camkes-vm/camkes-3.8.x.html">
            camkes-3.8.x-compatible
          </a>
        </li>

    </ul>

</div>


</div>

    </main>
    


<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      



<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Sun Feb 27 13:02:40 2022 +1100 4ffbb48
          </li>
          <li>
                Page last updated: Sun Feb 27 13:02:40 2022 +1100 4ffbb48
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
<a href="https://github.com/seL4/docs/blob/master/projects/camkes-vm/index.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/seL4/docs/edit/master/projects/camkes-vm/index.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>

  </body>
</html>
