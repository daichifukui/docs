<!DOCTYPE html>
<!--
     SPDX-License-Identifier: CC-BY-SA-4.0
     SPDX-FileCopyrightText: 2020 seL4 Project a Series of LF Projects, LLC.
-->
<!-- Page last generated 2023-09-23 03:17:17 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rust | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117737473-2"></script>
<script>
  if((window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window['ga-disable-UA-117737473-2'] = true;
  }
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117737473-2');
</script>
</head>

  <body class="container-fluid">

    



<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="https://sel4.systems" class="skip-icon">
              <img class="img-responsive" src="/assets/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/processes">Contributing</a></h2>
        <h2><a href="/projects">Projects</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <iframe title="DuckDuckGo search bar" src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search%20sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;border-width: 0px"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  
<div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
            </a>
            <meta property="position" content="1" />
        </li>
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/projects/">
              <span property="name"><b>Projects</b></span>
            </a>
            <meta property="position" content="2" />
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">Rust</span>
            <meta property="position" content="3" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/releases/sel4/12.1.0"><b>seL4-12.1.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/camkes/camkes-3.10.0"><b>camkes-3.10.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/capdl/0.2.1"><b>CapDL-0.2.1</b></a></li>
    </ol>
  </nav>
  <nav class="sel-version">
    <ol class="list-unstyled">
      <li class="list-unstyled text-center">
      <a href="https://sel4.discourse.group/t/15-june-2021-release/373"><b>Announcing new releases: </b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      <div class="row">
  <div class="hidden-xs col-sm-4 col-md-3 col-lg-2">
    


<div class="sidebar">















    <ul class="nav nav-sidebar">
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4/">seL4</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/l4v/">L4.verified</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/camkes/">CAmkES</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/capdl/">CapDL</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/elfloader/">Elfloader</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/buildsystem/">seL4 Buildsystem</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/user_libs/">user_libs</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4runtime/">The seL4 run-time</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4test/">seL4Test</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4-tutorials/">seL4 tutorials</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4webserver/">seL4webserver</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4bench/">sel4bench</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/camkes-vm/">camkes-vm</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/virtualization/">Virtualization</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/docsite/">seL4 Documentation website</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/dockerfiles/">Dockerfiles</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/sel4_tools/">seL4_tools</a>
        <li>
  
    
    

    
        <li class="">
            <a class="" href="/projects/hardware_hacks/">Hardware Hacks</a>
        <li>
  
    
    

    
        <li class="active">
            <a class="" href="/projects/rust/">Rust</a>
        <li>
  
    </ul>




</div>


  </div>
  <div class="content col-sm-8 col-md-6 col-lg-7 main">
    <h1 id="rust">Rust</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The rust support that this page talks about is no longer supported.
</code></pre></div></div>
<h3 id="description">Description:</h3>
<p>This page relates to using cargo based rust modules
in userspace on seL4 utilizing the existing build system. It focuses on
Interoperability between existing c based libraries and applications and
working with CAmkES. For rust only projects on seL4 see
<a href="https://rbg.systems/">the robigalia project</a>.</p>

<h3 id="setup">Setup:</h3>
<p>In addition to the typical sel4 build prerequisites you
also need to have rust installed. This is achieved by the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># This installs multirust from here: https://github.com/brson/multirust</span>
curl <span class="nt">-sf</span> https://raw.githubusercontent.com/brson/multirust/master/blastoff.sh | sh

<span class="c"># This will install cargo and rustc using the current nightly version</span>
multirust update nightly
<span class="c"># This will set the default cargo and rustc paths to the nightly version</span>
multirust default nightly
</code></pre></div></div>

<p>Additionally, if you want to use rust-bindgen (a helpful tool that
generates rust bindings from c header files, such as bindings to camkes
generated functions) you need to have libclang installed.</p>

<h3 id="sample-projects">Sample projects:</h3>

<p>There is currently a sample project
<a href="https://github.com/SEL4PROJ/rust-camkes-samples">rust-camkes-samples</a>
that demonstrates this functionality.</p>

<p>The following commands get a sample camkes hello world app written in
rust and runs it on qemu. It assumes that rust is installed correctly.</p>

<p>Note: the last rust nightly version this was specifically tested on is:
nightly-2016-06-01. Since then, the build-system and structure of the
upstream Rust compiler has changed, and <strong>is no longer compatible with
our Rust infrastructure</strong>. Please continue to use this older nightly
version until the project has been updated on our end, in the near
future.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># This just gets all of the sources</span>
repo init <span class="nt">-u</span> https://github.com/SEL4PROJ/rust-camkes-samples.git 
repo <span class="nb">sync</span>  
<span class="c"># Configuration for arm kzm (so we can use qemu)</span>
<span class="c"># helloworld app: make rust-helloworld-kzm_defconfig</span>
<span class="c"># keyvalue app: make rust-keyvalue-kzm_defconfig</span>
make rust-helloworld-kzm_defconfig
<span class="c"># Build and run on qemu</span>
make qemu-arm
</code></pre></div></div>

<h3 id="build-dependencies">Build Dependencies:</h3>
<p>In addition to the existing
<a href="/HostDependencies">seL4 dependencies and CAmkES dependencies</a>, the following dependencies are required:</p>

<ul>
  <li>cargo and rustc: These are the rust build tool and compiler, they
    should be installed with
    <a href="https://github.com/brson/multirust">multirust</a>
    (<a href="https://www.rustup.rs/">rustup.rs</a> is still in beta,
    and the build system has only been tested with multirust but
    rustup.sh should still be fine as long as rustc and cargo work)</li>
  <li>Cmake &gt;= 3.5.2</li>
</ul>

<p>The following features also require extra dependencies, however the
particular features are not required to build applications that don’t
use the features:</p>

<ul>
  <li>libclang: A dependency of rust-bindgen to generate rust bindings
    from C header files.</li>
  <li>linux-libc-dev:i386: Provides glibc headers for building libstd
    on x86.</li>
</ul>

<h3 id="build-overview">Build overview:</h3>
<p>Two features have been added to the seL4 build
system (seL4_tools):</p>

<ul>
  <li>The ability to use cargo projects as libraries or apps with other
    C based libraries or apps on seL4. The cargo project just needs to
    have a staticlib crate-type. To use rust projects as libraries
    that can be used by other C libraries or apps, the make file just
    needs to be</li>
</ul>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#This library uses a rust cargo project to generate it's lib*.a file
</span><span class="nv">RUST_TARGET</span> <span class="o">:=</span> libbtreemap.a
<span class="c"># Header files/directories this library provides
# The file is specified directly, as btreemap.h is generated by the rust task
</span><span class="nv">HDRFILES</span> <span class="o">:=</span> <span class="nv">${SOURCE_DIR}</span>/include/generated/btreemap.h
<span class="k">include</span><span class="sx"> $(SEL4_COMMON)/common.mk</span>
</code></pre></div></div>

<p>To use a cargo project as part of a camkes app component, in the
application’s Makefile, <code class="highlighter-rouge">COMPONENTNAME_RUST</code> needs to be set to the cargo
lib name.</p>

<p>For a non camkes application, to use a cargo project in an app then the
settings are the same as for a library: <code class="highlighter-rouge">RUST_TARGET := libcratename.a</code>.</p>

<ul>
  <li>The second feature of the build system, is that it cross compiles
    the core rust libraries for the the target architecture. Currently
    it builds std and all required libraries. Most of std won’t work
    (things that rely on muslc syscalls that are not supported
    on seL4). using <code class="highlighter-rouge">#![no_std]</code> should allow the project to just
    use core libraries and use extra libraries (such as
    collections, alloc) explicitly as needed. rust_sysroot is a make
    rule that needs to be added to the Kbuild file of any module that
    uses rust. Additionally, libcompiler-rt needs to be added to any
    applications that use cargo projects directly or indirectly.</li>
</ul>

<h2 id="known-issues">Known issues:</h2>

<ul>
  <li>Currently rely on a modified libmuslc with a hacked in global
      tls struct in order for rust printf functionality to work.</li>
  <li>Camkes apps are really bloated when they use rust. ~8 Mb of
      binary per app that uses rust it seems. This is likely related
      to a camkes linking issue.</li>
  <li>Most libstd functionality doesn’t actually work due to lack of
      syscall implementation in muslc on sel4. If concerned about this
      it may be better to use <code class="highlighter-rouge">#![no_std]</code> and explicitly use
      libcore, libcollections, liballoc, etc because they are more
      likely to work.</li>
  <li>No way of knowing at compile time which libstd functions don’t
      have underlying muslc implementations.</li>
</ul>


  </div>







  
  
<div class="sidebar-toc hidden-xs hidden-sm col-md-3 col-lg-3">
  
    <ul class="section-nav">
    	<h2> Rust </h2> 
        <li>
          
          <a style=" font-weight: bold; " class="" href="/projects/rust/">
            Documentation homepage
          </a>
        </li>

























  





    </ul>

</div>


</div>

    </main>
    


<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      



<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Tue Sep 19 12:39:04 2023 -0700 d4bd9b052c
          </li>
          <li>
                Page last updated: Thu Jan 27 20:08:19 2022 +1100 8274e01bba
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
<a href="https://github.com/seL4/docs/blob/master/projects/rust/index.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/seL4/docs/edit/master/projects/rust/index.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>

  </body>
</html>
