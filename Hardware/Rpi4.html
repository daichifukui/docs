<!DOCTYPE html>
<!--
     SPDX-License-Identifier: CC-BY-SA-4.0
     SPDX-FileCopyrightText: 2020 seL4 Project a Series of LF Projects, LLC.
-->
<!-- Page last generated 2022-12-13 03:18:56 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Raspberry PI 4 Model B | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117737473-2"></script>
<script>
  if((window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window['ga-disable-UA-117737473-2'] = true;
  }
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117737473-2');
</script>
</head>

  <body class="container-fluid">

    



<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="https://sel4.systems" class="skip-icon">
              <img class="img-responsive" src="/assets/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/processes">Contributing</a></h2>
        <h2><a href="/projects">Projects</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <iframe title="DuckDuckGo search bar" src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search%20sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;border-width: 0px"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  
<div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
            </a>
            <meta property="position" content="1" />
        </li>
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/Hardware/">
              <span property="name"><b>Supported Platforms</b></span>
            </a>
            <meta property="position" content="2" />
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">Raspberry PI 4 Model B</span>
            <meta property="position" content="3" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/releases/sel4/12.1.0"><b>seL4-12.1.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/camkes/camkes-3.10.0"><b>camkes-3.10.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/capdl/0.2.1"><b>CapDL-0.2.1</b></a></li>
    </ol>
  </nav>
  <nav class="sel-version">
    <ol class="list-unstyled">
      <li class="list-unstyled text-center">
      <a href="https://sel4.discourse.group/t/15-june-2021-release/373"><b>Announcing new releases: </b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      <div class="row">
  <div class="hidden-xs col-sm-4 col-md-3 col-lg-2">
    


<div class="sidebar">


















</div>


  </div>
  <div class="col-sm-8 col-md-9 col-lg-8 main">
    
    <div class="content">
      <h1 id="raspberry-pi-4-model-b">Raspberry PI 4 Model B</h1>

<h2 id="serial-connection">Serial connection</h2>
<p>Serial TX and RX are located at GPIO pins 14 and 15 respectively</p>

<h2 id="u-boot">U-Boot</h2>

<p>Right now, the default U-Boot will not successfully boot an seL4 image
on the RPi4 because of cache configuration issues in the seL4
ELFLoader. This problem can be remedied by having U-boot disable caches
before loading seL4. Unfortunately, the stock upstream U-boot used to
disable caches before loading the kernel image, but as of this patch
(<a href="https://github.com/u-boot/u-boot/commit/995eab8b5b580b67394312b1621c60a71042cd18">https://github.com/u-boot/u-boot/commit/995eab8b5b580b67394312b1621c60a71042cd18</a>),
U-boot no longer disables caches.</p>

<p>In order to obtain a U-boot binary that disables caching, you should
compile U-Boot from source yourself.
You can do this by cloning U-boot from upstream,
then reverting commit 995eab8b5b580b67394312b1621c60a71042cd18, and then
building it:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/u-boot/u-boot.git u-boot
<span class="nb">cd </span>u-boot
git revert 995eab8b5b580b67394312b1621c60a71042cd18
make <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- rpi_4_defconfig
make <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu-
</code></pre></div></div>

<p>This will enable you to get the most up-to-date U-boot which will boot
seL4 on the RPi4 successfully.</p>

<p><strong>NOTE:</strong> Automatic revert is not going to work if you are using the
latest version of u-boot. You need to manually revert the change by
looking at the changeset.</p>

<h2 id="sd-card-setup">SD card setup</h2>
<p>The PI boots from the first FAT32 partition on the
SD card. Where files are specified, they should be located in the root
directory of this partition.</p>

<table>
  <thead>
    <tr>
      <th>Stage</th>
      <th>Filename</th>
      <th>Description</th>
      <th>Source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>FSBL</td>
      <td>-</td>
      <td>Mounts SD and loads SSBL</td>
      <td>ROM</td>
    </tr>
    <tr>
      <td>SSBL</td>
      <td>bootcode.bin</td>
      <td>Loads GPU firmware and boots GPU</td>
      <td><a href="https://github.com/raspberrypi/firmware/tree/master/boot">https://github.com/raspberrypi/firmware/tree/master/boot</a></td>
    </tr>
    <tr>
      <td>GPU firmware</td>
      <td>start4.elf</td>
      <td>Loads CPU bootloader and boots CPU</td>
      <td><a href="https://github.com/raspberrypi/firmware/tree/master/boot">https://github.com/raspberrypi/firmware/tree/master/boot</a></td>
    </tr>
    <tr>
      <td>Usually the Linux kernel, but could also be u-boot</td>
      <td>u-boot.bin</td>
      <td>u-boot</td>
      <td>Compiled using the instructions above</td>
    </tr>
    <tr>
      <td> </td>
      <td>config.txt</td>
      <td>u-boot parameters</td>
      <td>Add <code class="highlighter-rouge">arm_64bit=1</code>, <code class="highlighter-rouge">kernel=u-boot.bin</code>, and <code class="highlighter-rouge">dtoverlay=disable-bt</code> to the bottom of config.txt</td>
    </tr>
    <tr>
      <td> </td>
      <td>uboot.env</td>
      <td>u-boot saved environment</td>
      <td>Generated by u-boot (default environment) bootcmd copied to bootcmd_orig bootcmd and bootdelay removed</td>
    </tr>
    <tr>
      <td> </td>
      <td>bcm2711-rpi-4-b.dtb</td>
      <td>RPi4 device tree blob</td>
      <td><a href="https://github.com/raspberrypi/firmware/tree/master/boot">https://github.com/raspberrypi/firmware/tree/master/boot</a></td>
    </tr>
    <tr>
      <td> </td>
      <td>overlays/*</td>
      <td>Device tree overlays</td>
      <td><a href="https://github.com/raspberrypi/firmware/tree/master/boot/overlays">https://github.com/raspberrypi/firmware/tree/master/boot/overlays</a></td>
    </tr>
  </tbody>
</table>

<h2 id="getting-sel4-onto-your-raspberry-pi-4">Getting seL4 onto your Raspberry Pi 4</h2>

<p>Because you have applied a device tree overlay to use the UART on GPIO pins 14 and 15,
you will have to update seL4 to use serial0 instead of serial1.
In the kernel at <code class="highlighter-rouge">src/plat/bcm2711/overlay-rpi4.dts</code>, you should replace all instances of
<code class="highlighter-rouge">serial1</code> with <code class="highlighter-rouge">serial0</code>.</p>

<p>Then, you should then build the kernel, such as in seL4test:</p>

<p>Checkout the sel4test project using repo as per <a href="/seL4Test">seL4Test</a></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>repo init <span class="nt">-u</span> https://github.com/seL4/sel4test-manifest.git
repo <span class="nb">sync
mkdir </span>cbuild
<span class="nb">cd </span>cbuild
../init-build.sh <span class="nt">-DPLATFORM</span><span class="o">=</span>rpi4 <span class="nt">-DAARCH64</span><span class="o">=</span>1
<span class="c"># The default cmake wrapper sets up a default configuration for the target platform.</span>
<span class="c"># To change individual settings, run `ccmake` and change the configuration</span>
<span class="c"># parameters to suit your needs.</span>
ninja

</code></pre></div></div>

<p>Generated binaries can be found in the <code class="highlighter-rouge">images/</code> directory.</p>

<p>The boot method described here is through the SD card. You should set up the files
on your SD card as described in the previous section.</p>

<p>Following this, copy your seL4 image (such as an seL4test image) onto
the SD card in its root directory. You can now remove the SD
card from your PC and re-insert it into the RPi4, and power the RPi4 on.</p>

<p>When the RPi4 boots up, be sure to interrupt the boot process and drop
into the U-boot command prompt. From the U-boot command prompt, type
something like the following: <code class="highlighter-rouge">fatls mmc 0</code>. If you don’t see your seL4 image
filename printed out, then you might need to double-check your steps
so far to make sure you didn’t forget something along the way. If you
see your file listed, then do something like:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fatload mmc 0 0x10000000 sel4test-driver-image-arm-bcm2711
bootefi 0x10000000
</code></pre></div></div>

    </div>
  </div>
</div>

    </main>
    


<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      



<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Tue Dec 13 09:33:19 2022 +1100 d1e8d73
          </li>
          <li>
                Page last updated: Tue Dec 13 09:33:19 2022 +1100 d1e8d73
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
<a href="https://github.com/seL4/docs/blob/master/Hardware/Rpi4.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/seL4/docs/edit/master/Hardware/Rpi4.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>

  </body>
</html>
